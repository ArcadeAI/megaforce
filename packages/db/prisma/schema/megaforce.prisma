// Megaforce Database Schema
// AI content generation platform â€” session-workflow model

// ============================================================================
// ENUMS
// ============================================================================

enum SourceType {
  URL
  TEXT
  PDF
}

enum OutputType {
  BLOG_POST
  ARTICLE
  SOCIAL_MEDIA
  TECHNICAL_DOCS
  MARKETING_COPY
  CUSTOM
}

enum SessionStage {
  OUTPUT_SELECTION
  CLARIFYING
  PERSONA
  PLAN
  OUTLINE
  GENERATION
  COMPLETE
}

enum SessionStatus {
  ACTIVE
  PAUSED
  COMPLETED
  ARCHIVED
}

enum ReviewStatus {
  DRAFT
  CRITIC_REVIEWING
  CRITIC_APPROVED
  USER_APPROVED
  REJECTED
}

enum DataSourceMode {
  CORPUS_ONLY
  DEEP_RESEARCH
  BOTH
}

enum JobType {
  SOURCE_INGESTION
  PLAN_GENERATION
  CRITIC_REVIEW
  OUTLINE_GENERATION
  CONTENT_GENERATION
}

// ============================================================================
// CORE ENTITIES
// ============================================================================

model Workspace {
  id        String   @id @default(cuid())
  name      String
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sources       Source[]
  personas      Persona[]
  sessions      ContentSession[]
  jobs          JobQueue[]
  wsConnections WebSocketConnection[]

  // Publishing relations (Phase 11)
  projects         Project[]
  candidates       ContentCandidate[]
  publishedContent PublishedContent[]

  @@index([userId])
  @@map("workspace")
}

model Source {
  id            String     @id @default(cuid())
  workspaceId   String
  workspace     Workspace  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  type          SourceType
  title         String
  url           String?
  fileUrl       String?
  content       String?    @db.Text
  parsedContent String?    @db.Text
  wordCount     Int?
  metadata      Json?
  status        String     @default("pending") // pending, parsing, parsed, failed
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  sessionSources SessionSource[]

  // Publishing relations (Phase 11)
  personaSources PersonaSource[]
  projectSources ProjectSource[]

  @@index([workspaceId])
  @@index([type])
  @@index([status])
  @@map("source")
}

model Persona {
  id              String   @id @default(cuid())
  workspaceId     String
  workspace       Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  name            String
  description     String?  @db.Text
  styleProfile    Json     // Structured style attributes
  vocabularyLevel String?
  perspective     String?
  sentenceStyle   String?
  sampleOutput    String?  @db.Text
  isDefault       Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  sessionPersonas SessionPersona[]

  // Publishing relations (Phase 11)
  personaSources   PersonaSource[]
  socialChannels   SocialChannel[]
  projectPersonas  ProjectPersona[]
  candidates       ContentCandidate[]
  publishedContent PublishedContent[]

  @@index([workspaceId])
  @@map("persona")
}

// ============================================================================
// SESSION WORKFLOW
// ============================================================================

model ContentSession {
  id                String         @id @default(cuid())
  workspaceId       String
  workspace         Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  title             String
  currentStage      SessionStage   @default(OUTPUT_SELECTION)
  status            SessionStatus  @default(ACTIVE)
  outputTypes       Json?          // Array of OutputType values
  clarifyingAnswers Json?          // { tone, audience, keywords, context, etc. }
  dataSourceMode    DataSourceMode @default(CORPUS_ONLY)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  sessionPersonas  SessionPersona[]
  sessionSources   SessionSource[]
  plans            Plan[]
  outlines         Outline[]
  knowledgeBases   KnowledgeBase[]
  generatedContent GeneratedContent[]

  @@index([workspaceId])
  @@index([status])
  @@index([currentStage])
  @@map("content_session")
}

model SessionPersona {
  id            String         @id @default(cuid())
  sessionId     String
  session       ContentSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  personaId     String
  persona       Persona        @relation(fields: [personaId], references: [id], onDelete: Cascade)
  role          String         @default("PRIMARY") // PRIMARY, SECONDARY
  blendStrategy Json?
  createdAt     DateTime       @default(now())

  @@unique([sessionId, personaId])
  @@index([sessionId])
  @@index([personaId])
  @@map("session_persona")
}

model SessionSource {
  id        String         @id @default(cuid())
  sessionId String
  session   ContentSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sourceId  String
  source    Source         @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  createdAt DateTime       @default(now())

  @@unique([sessionId, sourceId])
  @@index([sessionId])
  @@index([sourceId])
  @@map("session_source")
}

// ============================================================================
// PLAN
// ============================================================================

model Plan {
  id               String         @id @default(cuid())
  sessionId        String
  session          ContentSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  version          Int            @default(1)
  content          Json           // { executiveSummary, audience, messages, structure, criteria }
  status           ReviewStatus   @default(DRAFT)
  criticFeedback   Json?          // Array of { iteration, approved, objections, suggestions }
  criticIterations Int            @default(0)
  createdAt        DateTime       @default(now())

  outlines Outline[]

  @@index([sessionId])
  @@index([status])
  @@map("plan")
}

// ============================================================================
// OUTLINE
// ============================================================================

model Outline {
  id               String         @id @default(cuid())
  sessionId        String
  session          ContentSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  planId           String
  plan             Plan           @relation(fields: [planId], references: [id], onDelete: Cascade)
  version          Int            @default(1)
  content          Json           // { sections: [{ title, subsections, keyPoints, sourceRefs }] }
  status           ReviewStatus   @default(DRAFT)
  criticFeedback   Json?
  criticIterations Int            @default(0)
  createdAt        DateTime       @default(now())

  generatedContent GeneratedContent[]

  @@index([sessionId])
  @@index([planId])
  @@index([status])
  @@map("outline")
}

// ============================================================================
// KNOWLEDGE BASE
// ============================================================================

model KnowledgeBase {
  id        String         @id @default(cuid())
  sessionId String
  session   ContentSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  entries KnowledgeEntry[]

  @@index([sessionId])
  @@map("knowledge_base")
}

model KnowledgeEntry {
  id              String        @id @default(cuid())
  knowledgeBaseId String
  knowledgeBase   KnowledgeBase @relation(fields: [knowledgeBaseId], references: [id], onDelete: Cascade)
  fact            String        @db.Text
  sourceRef       String?
  confidence      Float         @default(1.0)
  relevanceScore  Float         @default(1.0)
  relatedEntryIds Json?
  createdAt       DateTime      @default(now())

  @@index([knowledgeBaseId])
  @@map("knowledge_entry")
}

// ============================================================================
// GENERATED CONTENT
// ============================================================================

model GeneratedContent {
  id               String         @id @default(cuid())
  sessionId        String
  session          ContentSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  outlineId        String
  outline          Outline        @relation(fields: [outlineId], references: [id], onDelete: Cascade)
  version          Int            @default(1)
  content          String         @db.Text
  sections         Json?          // Array of { title, content, outlineSectionIndex }
  status           ReviewStatus   @default(DRAFT)
  criticFeedback   Json?
  criticIterations Int            @default(0)
  metrics          Json?          // { wordCount, readingTime, criticIterations }
  createdAt        DateTime       @default(now())

  @@index([sessionId])
  @@index([outlineId])
  @@index([status])
  @@map("generated_content")
}

// ============================================================================
// BACKGROUND PROCESSING
// ============================================================================

model JobQueue {
  id          String   @id @default(cuid())
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  jobType     JobType
  jobData     Json
  status      String   @default("pending") // pending, processing, completed, failed
  priority    Int      @default(5)
  attempts    Int      @default(0)
  maxAttempts Int      @default(3)
  error       String?  @db.Text
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([workspaceId])
  @@index([jobType])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@map("job_queue")
}

model WebSocketConnection {
  id           String    @id @default(cuid())
  workspaceId  String
  workspace    Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  connectionId String    @unique
  connectedAt  DateTime  @default(now())
  lastPingAt   DateTime  @default(now())

  @@index([workspaceId])
  @@index([userId])
  @@index([connectionId])
  @@map("websocket_connection")
}
